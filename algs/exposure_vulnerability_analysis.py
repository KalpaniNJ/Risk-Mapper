from qgis.PyQt.QtCore import QCoreApplication
from qgis.PyQt.QtGui import QIcon
from qgis.core import (
    QgsProcessing,
    QgsProcessingAlgorithm,
    QgsProcessingParameterRasterLayer,
    QgsProcessingParameterRasterDestination
)
from qgis import processing
import os


class ExposureVulnerabilityAnalysisAlgorithm(QgsProcessingAlgorithm):
    
    """
    Applies a binary mask to an input raster to generate a masked raster for exposure and vulnerability analysis.
    This operation retains values only in areas defined by the mask (e.g., exposed or vulnerable regions).
    """

    INPUT = "INPUT"
    MASK = "MASK"
    OUTPUT = "OUTPUT"

    def tr(self, string):
        return QCoreApplication.translate("ExposureVulnerabilityAnalysis", string)

    def createInstance(self):
        return ExposureVulnerabilityAnalysisAlgorithm()
        
    def icon(self):
            plugin_dir = os.path.dirname(__file__)
            icon_path = os.path.join(plugin_dir, "icons", "binoverlay_icon.jpeg")
            return QIcon(icon_path)  

    def name(self):
        return "exposurevulnerabilityanalysis"

    def displayName(self):
        return self.tr("Binary Mask Overlay")

    def group(self):
        return self.tr("4_Raster analysis")

    def groupId(self):
        return "raster_analysis"

    def shortHelpString(self):
        return self.tr("Applies a binary mask to an input raster to generate a masked raster for exposure and vulnerability analysis. This retains values only in areas defined by the mask")

    def initAlgorithm(self, config=None):
        # Input raster
        self.addParameter(
            QgsProcessingParameterRasterLayer(self.INPUT, self.tr("Input binary raster"))
        )

        # Mask raster
        self.addParameter(
            QgsProcessingParameterRasterLayer(self.MASK, self.tr("Mask raster"))
        )

        # Output raster
        self.addParameter(
            QgsProcessingParameterRasterDestination(self.OUTPUT, self.tr("Output raster"))
        )

    def processAlgorithm(self, parameters, context, feedback):
        input_layer = self.parameterAsRasterLayer(parameters, self.INPUT, context)
        mask_layer = self.parameterAsRasterLayer(parameters, self.MASK, context)
        output_path = self.parameterAsOutputLayer(parameters, self.OUTPUT, context)

        input_layer_name = os.path.splitext(os.path.basename(input_layer.source()))[0]
        crop_layer_name = os.path.splitext(os.path.basename(mask_layer.source()))[0]

        # Perform raster multiplication
        calc_result = processing.run(
            "native:rastercalc",
            {
                'LAYERS': [input_layer.source(), mask_layer.source()],
                'EXPRESSION': '"{}@1" * "{}@1"'.format(input_layer.name(), mask_layer.name()),
                'OUTPUT': 'TEMPORARY_OUTPUT'
            },
            context=context,
            feedback=feedback
        )

        # Save output with compression
        processing.run(
            "gdal:translate",
            {
                'INPUT': calc_result['OUTPUT'],
                'OPTIONS': 'COMPRESS=LZW',
                'DATA_TYPE': None,
                'OUTPUT': output_path
            },
            context=context,
            feedback=feedback
        )

        feedback.pushInfo("Processing completed.")
        return {self.OUTPUT: output_path}
