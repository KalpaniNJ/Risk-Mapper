from qgis.PyQt.QtCore import QCoreApplication
from qgis.PyQt.QtGui import QIcon
from qgis.core import (
    QgsProcessing,
    QgsProcessingAlgorithm,
    QgsProcessingParameterVectorLayer,
    QgsProcessingParameterRasterLayer,
    QgsProcessingParameterVectorDestination,
    QgsProcessingParameterEnum,
    QgsProcessingParameterString,
    QgsVectorLayer
)
import os
import processing


class VulnerabilityStatsAlgorithm(QgsProcessingAlgorithm):
    ADMIN = "ADMIN"
    INPUT_RASTER = "INPUT_RASTER"
    STAT = "STAT"
    COLUMN_PREFIX = "COLUMN_PREFIX"
    OUTPUT = "OUTPUT"

    def tr(self, text):
        return QCoreApplication.translate("VulnerabilityStatsAlgorithm", text)

    def createInstance(self):
        return VulnerabilityStatsAlgorithm()
        
    def icon(self):
            plugin_dir = os.path.dirname(__file__)
            icon_path = os.path.join(plugin_dir, "icons", "vulstat_icon.jpeg")
            return QIcon(icon_path)

    def name(self):
        return "vulnerability_zonal_statistics"

    def displayName(self):
        return self.tr("Calculate zonal statistics for vulnerability")

    def group(self):
        return self.tr("5_Statistical analysis")

    def groupId(self):
        return "statistical_analysis"

    def shortHelpString(self):
        return self.tr("Runs zonal statistics for a raster and joins results to an input vector layer.")

    def initAlgorithm(self, config=None):
        self.addParameter(
            QgsProcessingParameterVectorLayer(
                self.ADMIN,
                self.tr("Input vector layer"),
                [QgsProcessing.TypeVectorPolygon]
            )
        )

        self.addParameter(
            QgsProcessingParameterRasterLayer(
                self.INPUT_RASTER,
                self.tr("Input raster layer")
            )
        )

        self.addParameter(
            QgsProcessingParameterEnum(
                self.STAT,
                self.tr("Statistic to calculate"),
                options=[
                    "Count", "Sum", "Mean", "Median",
                    "StDev", "Min", "Max", "Range", "Minority", "Majority", "Variety"
                ],
                defaultValue=0
            )
        )

        # NEW: column prefix parameter
        self.addParameter(
            QgsProcessingParameterString(
                self.COLUMN_PREFIX,
                self.tr("Output column prefix"),
                defaultValue="stat_"
            )
        )

        self.addParameter(
            QgsProcessingParameterVectorDestination(
                self.OUTPUT,
                self.tr("Final output")
            )
        )

    def processAlgorithm(self, parameters, context, feedback):
        admin_layer = self.parameterAsVectorLayer(parameters, self.ADMIN, context)
        raster_layer = self.parameterAsRasterLayer(parameters, self.INPUT_RASTER, context)
        stat_choice = self.parameterAsEnum(parameters, self.STAT, context)
        column_prefix = self.parameterAsString(parameters, self.COLUMN_PREFIX, context)
        output_path = self.parameterAsOutputLayer(parameters, self.OUTPUT, context)

        # QGIS native:zonalstatisticsfb stats mapping
        stats_map = {
            0: [0],   # Count
            1: [1],   # Sum
            2: [2],   # Mean
            3: [3],   # Median
            4: [4],   # StDev
            5: [5],   # Min
            6: [6],   # Max
            7: [7],   # Range
            8: [8],   # Minority
            9: [9],   # Majority
            10: [10], # Variety
        }

        feedback.pushInfo(f"Running zonal statistics with {raster_layer.name()} and prefix '{column_prefix}'")

        result = processing.run("native:zonalstatisticsfb", {
            'INPUT': admin_layer,
            'INPUT_RASTER': raster_layer,
            'RASTER_BAND': 1,
            'COLUMN_PREFIX': column_prefix,
            'STATISTICS': stats_map[stat_choice],
            'OUTPUT': 'memory:'
        }, context=context, feedback=feedback)

        final_layer = result['OUTPUT']

        # Save final output
        processing.run("native:savefeatures", {
            'INPUT': final_layer,
            'OUTPUT': output_path
        }, context=context, feedback=feedback)

        return {self.OUTPUT: output_path}
