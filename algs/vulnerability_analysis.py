from qgis.PyQt.QtCore import QCoreApplication
from qgis.PyQt.QtGui import QIcon
from qgis.core import (
    QgsProcessing,
    QgsProcessingAlgorithm,
    QgsProcessingParameterFile,
    QgsProcessingParameterFolderDestination,
    QgsProcessingParameterString,
    QgsProcessingParameterBoolean,
    QgsProcessingParameterRasterLayer,
    QgsRasterLayer,
    QgsProject,
    QgsProcessingException
)
from qgis import processing
import os

class VulnerabilityAnalysisAlgorithm(QgsProcessingAlgorithm):
    INPUT_DIR = "INPUT_DIR"
    HAZARD_MASK = "HAZARD_MASK"
    OUTPUT_DIR = "OUTPUT_DIR"
    PREFIX = "PREFIX"
    LOAD_RESULT = "LOAD_RESULT"

    def tr(self, string):
        return QCoreApplication.translate("VulnerabilityAnalysis", string)

    def createInstance(self):
        return VulnerabilityAnalysisAlgorithm()
        
    def icon(self):
            plugin_dir = os.path.dirname(__file__)
            icon_path = os.path.join(plugin_dir, "icons", "vul_icon.jpeg")
            return QIcon(icon_path)

    def name(self):
        return "vulnerabilityanalysis"

    def displayName(self):
        return self.tr("Vulnerability maps")

    def group(self):
        return self.tr("3_Vulnerability analysis")

    def groupId(self):
        return "vulnerability_analysis"

    def shortHelpString(self):
        return self.tr(
            "Generates vulnerability rasters by masking vulnerability indices rasters with the hazard raster. "
        )

    def initAlgorithm(self, config=None):
        # Input folder
        self.addParameter(
            QgsProcessingParameterFile(
                self.INPUT_DIR,
                self.tr("Input folder"),
                behavior=QgsProcessingParameterFile.Folder
            )
        )

        # Binary hazard raster (mask)
        self.addParameter(
            QgsProcessingParameterRasterLayer(
                self.HAZARD_MASK,
                self.tr("Extent raster")
            )
        )

        # Output folder
        self.addParameter(
            QgsProcessingParameterFolderDestination(
                self.OUTPUT_DIR,
                self.tr("Output folder")
            )
        )

        self.addParameter(
            QgsProcessingParameterString(
                self.PREFIX,
                self.tr("Output file prefix"),
                defaultValue="_"
            )
        )

        # Option to auto-load into QGIS
        self.addParameter(
            QgsProcessingParameterBoolean(
                self.LOAD_RESULT,
                self.tr("Load layers on completion"),
                defaultValue=True
            )
        )

    def processAlgorithm(self, parameters, context, feedback):
        input_dir = self.parameterAsFile(parameters, self.INPUT_DIR, context)
        hazard_layer = self.parameterAsRasterLayer(parameters, self.HAZARD_MASK, context)
        hazard_mask = hazard_layer.source()
        output_dir = self.parameterAsFile(parameters, self.OUTPUT_DIR, context)
        prefix = self.parameterAsString(parameters, self.PREFIX, context)
        load_result = self.parameterAsBool(parameters, self.LOAD_RESULT, context)

        os.makedirs(output_dir, exist_ok=True)

        results = []
        crop_layer_name = os.path.splitext(os.path.basename(hazard_mask))[0]

        for filename in os.listdir(input_dir):
            if not filename.lower().endswith(".tif"):
                continue

            input_path = os.path.join(input_dir, filename)
            base_name = os.path.splitext(filename)[0]
            output_path = os.path.join(output_dir, f"{prefix}_{base_name}.tif")

            feedback.pushInfo(f"Processing {filename} â†’ {output_path}")

            # Raster calculation
            calc_result = processing.run(
                "native:rastercalc",
                {
                    'LAYERS': [input_path, hazard_mask],
                    'EXPRESSION': f'"{base_name}@1" * "{crop_layer_name}@1"',
                    'OUTPUT': 'TEMPORARY_OUTPUT'
                },
                context=context,
                feedback=feedback
            )

            processing.run(
                "gdal:translate",
                {
                    'INPUT': calc_result['OUTPUT'],
                    'OPTIONS': 'COMPRESS=LZW',
                    'DATA_TYPE': None,  # Float32
                    'OUTPUT': output_path
                },
                context=context,
                feedback=feedback
            )

            if load_result:
                rlayer = QgsRasterLayer(output_path, os.path.basename(output_path))
                if rlayer.isValid():
                    QgsProject.instance().addMapLayer(rlayer)

        feedback.pushInfo(f"Completed vulnerability analysis, saved {len(results)} rasters.")
        return {self.OUTPUT_DIR: output_dir}
